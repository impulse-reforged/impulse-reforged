name: Generate Version JSON

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate version JSON
        run: |
          # Detect if this repository is a fork and, if so, fetch the parent (original) repository
          # so we can include its commits when generating the version count.
          VALID_COUNT=0
          # Hardcode the original repository to always include its commits in the count
          # This is the upstream/original repository to include: https://github.com/aLoneWitness/impulse
          PARENT_FULL_NAME="aLoneWitness/impulse"
          # If that repo uses a different default branch, change this value (commonly 'main' or 'master')
          PARENT_DEFAULT_BRANCH="main"

          # If a parent (original) repository exists and is different, add it as an 'upstream' remote
          if [ -n "$PARENT_FULL_NAME" ] && [ "$PARENT_FULL_NAME" != "$GITHUB_REPOSITORY" ]; then
            echo "Detected parent repository: $PARENT_FULL_NAME (default branch: $PARENT_DEFAULT_BRANCH)"
            git remote add upstream "https://github.com/$PARENT_FULL_NAME.git" || true
            # Fetch the parent repository refs so we can reference its branch
            git fetch upstream --no-tags --prune
          fi

          # Build a list of refs to count commits from. Always include HEAD (this repo),
          # and include the parent repo default branch if present.
          REVLIST_REFS="HEAD"
          if [ -n "$PARENT_FULL_NAME" ] && [ -n "$PARENT_DEFAULT_BRANCH" ]; then
            REVLIST_REFS="$REVLIST_REFS upstream/$PARENT_DEFAULT_BRANCH"
          fi

          # Count valid commits across the specified refs since the given date. Using multiple
          # refs with git rev-list will list unique commits reachable from any of them.
          for COMMIT in $(git rev-list --reverse --since="2025-07-18" $REVLIST_REFS); do
            AUTHOR=$(git show -s --format='%ae' $COMMIT)
            PARENTS=$(git rev-list --parents -n 1 $COMMIT | wc -w)

            # Exclude GitHub Actions auto-commits and merge commits with 3+ parents (octopus)
            if [[ "$AUTHOR" != "github-actions@github.com" && "$PARENTS" -lt 3 ]]; then
              VALID_COUNT=$((VALID_COUNT + 1))
            fi
          done

          # Versioning format:
          # < 100       => 0.0.X
          # 100â€“999     => 0.X.Y
          # 1000+       => X.Y.Z
          if (( VALID_COUNT < 100 )); then
              MAJOR=0
              MINOR=0
              PATCH=$VALID_COUNT
          elif (( VALID_COUNT < 1000 )); then
              MAJOR=0
              MINOR=$((VALID_COUNT / 100))
              PATCH=$((VALID_COUNT % 100))
          else
              MAJOR=$((VALID_COUNT / 1000))
              MINOR=$(((VALID_COUNT % 1000) / 100))
              PATCH=$((VALID_COUNT % 100))
          fi

          PATCH_PADDED=$(printf "%02d" $PATCH)
          VERSION="$MAJOR.$MINOR.$PATCH_PADDED"

          echo "{" > version.json
          echo "  \"version\": \"$VERSION\"," >> version.json
          echo "  \"commitCount\": $VALID_COUNT," >> version.json
          echo "  \"commitHash\": \"$(git rev-parse --short HEAD)\"," >> version.json
          echo "  \"branch\": \"main\"" >> version.json
          echo "}" >> version.json

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Commit and push version file
        run: |
          git add -f version.json

          if git diff --cached --quiet; then
            echo "No changes to version file. Skipping commit."
            exit 0
          fi

          git commit -m "[skip ci] [ci version bump] Update version.json"
          git push
